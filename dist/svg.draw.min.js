/*! svg.draw - v1.0.0 - 2015-05-23
* https://github.com/Fuzzyma/svg.draw.js
* Copyright (c) 2015 Ulrich-Matthias Sch√§fer; Licensed MIT */
(function(){function a(a){var b=0,c=0;if("doc"in a){var d=a.bbox();b=d.x,c=d.y,a=a.doc().parent}for(;"BODY"!==a.nodeName.toUpperCase();)b+=a.offsetLeft,c+=a.offsetTop,a=a.offsetParent;return{x:b,y:c}}function b(a,b,c){var d=this;a.remember("_paintHandler",this),this.el=a,this.parent=a.parent._parent(SVG.Nested)||a._parent(SVG.Doc),this.set=this.parent.set(),this.parameters={},this.event=b,this.plugin=this.getPlugin();for(var e in c)this.el.draw.defaults.hasOwnProperty(e)||(c[e]=this.el.draw.defaults[e]);this.options=c,b?this.start(b):this.parent.on("click.draw",function(a){d.start(a||window.event)})}b.prototype.start=function(b){this.parameters={x:b.pageX,y:b.pageY,offset:a(this.parent)};var c={},d=this.el,e=this;switch(d.type){case"rect":c={x:b.pageX,y:b.pageY,height:1,width:1},d.attr(c),this.calc=function(a){c.x=this.parameters.x,c.y=this.parameters.y,c.height=a.pageY-c.y,c.width=a.pageX-c.x,c.x-=this.parameters.offset.x,c.y-=this.parameters.offset.y,this.snapToGrid(c),c.width<1&&(c.x=c.x+c.width,c.width=-c.width),c.height<1&&(c.y=c.y+c.height,c.height=-c.height),d.attr(c)};break;case"line":this.calc=function(a){c.x1=this.parameters.x-this.parameters.offset.x,c.y1=this.parameters.y-this.parameters.offset.y,c.x2=a.pageX-this.parameters.offset.x,c.y2=a.pageY-this.parameters.offset.y,this.snapToGrid(c),d.attr(c)};break;case"polyline":case"polygon":d.array.value[0]=this.snapToGrid([b.pageX-this.parameters.offset.x,b.pageY-this.parameters.offset.y]),d.array.value[1]=this.snapToGrid([b.pageX-this.parameters.offset.x,b.pageY-this.parameters.offset.y]),d.plot(d.array),this.drawCircles(d.array.value),this.calc=function(a){d.array.value.pop(),a&&d.array.value.push(this.snapToGrid([a.pageX-this.parameters.offset.x,a.pageY-this.parameters.offset.y])),d.plot(d.array)};break;case"ellipse":c={cx:b.pageX,cy:b.pageY,rx:1,ry:1},this.snapToGrid(c),d.attr(c),this.calc=this.options.useRadius?function(a){c.cx=this.parameters.x-this.parameters.offset.x,c.cy=this.parameters.y-this.parameters.offset.y,c.rx=c.ry=Math.sqrt((a.pageX-this.parameters.x)*(a.pageX-this.parameters.x)+(a.pageY-this.parameters.y)*(a.pageY-this.parameters.y)),this.snapToGrid(c),d.attr(c)}:function(a){c.cx=this.parameters.x-this.parameters.offset.x,c.cy=this.parameters.y-this.parameters.offset.y,c.rx=Math.abs(a.pageX-this.parameters.x),c.ry=Math.abs(a.pageY-this.parameters.y),this.snapToGrid(c),d.attr(c)};break;default:if(!this.plugin)return;this.plugin.init.call(this,b),this.calc=this.plugin.calc}d.fire("drawstart",[b.pageX-this.parameters.offset.x,b.pageY-this.parameters.offset.y]),SVG.on(window,"mousemove.draw",function(a){e.update(a||window.event)}),this.start=this.point},b.prototype.point=function(a){if(this.plugin&&this.plugin.point)return void this.plugin.point.call(this,a);if(this.el.type.indexOf("poly")>-1){var b=[a.pageX-this.parameters.offset.x,a.pageY-this.parameters.offset.y];return this.el.array.value.push(this.snapToGrid(b)),this.el.plot(this.el.array),this.drawCircles(this.el.array.value),void this.el.fire("drawpoint",b)}this.stop(a)},b.prototype.stop=function(a){a&&this.update(a),this.set.each(function(){this.remove()}),SVG.off(window,"mousemove.draw"),this.parent.off("click.draw"),this.el.forget("_paintHandler"),this.el.draw=function(){},this.el.fire("drawstop")},b.prototype.update=function(a){var b=[a.pageX-this.parameters.offset.x,a.pageY-this.parameters.offset.y];this.calc(a),this.el.fire("drawupdate",b)},b.prototype.done=function(){this.calc(),this.stop(),this.el.fire("drawdone")},b.prototype.cancel=function(){this.stop(),this.el.remove(),this.el.fire("drawcancel")},b.prototype.drawCircles=function(a){this.set.each(function(){this.remove()}),this.set.clear();for(var b=0;b<a.length;++b)this.set.add(this.parent.circle(5).stroke({width:1}).fill("#ccc").center(a[b][0],a[b][1]))},b.prototype.snapToGrid=function(a){var b=null;if(a.length)return b=[a[0]%this.options.snapToGrid,a[1]%this.options.snapToGrid],a[0]-=b[0]<this.options.snapToGrid/2?b[0]:b[0]-this.options.snapToGrid,a[1]-=b[1]<this.options.snapToGrid/2?b[1]:b[1]-this.options.snapToGrid,a;for(var c in a)b=a[c]%this.options.snapToGrid,a[c]-=(b<this.options.snapToGrid/2?b:b-this.options.snapToGrid)+(0>b?this.options.snapToGrid:0);return a},b.prototype.getPlugin=function(){return this.el.draw.plugins[this.el.type]},SVG.extend(SVG.Element,{draw:function(a,c){a instanceof Event||"string"==typeof a||(c=a,a=null);var d=this.remember("_paintHandler")||new b(this,a,c||{});return d[a]&&d[a](c),this}}),SVG.Element.prototype.draw.defaults={useRadius:!1,snapToGrid:1},SVG.Element.prototype.draw.plugins={}}).call(this);